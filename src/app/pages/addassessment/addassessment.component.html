<div *ngIf="loading" class="loading-overlay">
  <div class="loading-indicator">
    Loading...
  </div>
</div>

<nav class="navbar">
  <div class="container">
    <h1 class="logo"><a routerLink="'/dashboard" (click)="onDashboard()">Dashboard</a> / Add Moodle Assessment</h1>
  </div>
</nav>

<div class="form-container">
  <h2>Add Assessment</h2>
  <form [formGroup]="assessmentForm" (ngSubmit)="onSubmit()">
          <label for="module">Module</label>
          <select id="module" formControlName="module" class="form-control">
            <option value="" disabled selected>Select a module</option>
            <option *ngFor="let module of modules" [value]="module.ModuleCode">{{ module.ModuleCode }}</option>
          </select>
    
    <div class="form-group">
          <label for="moderator">Moderator</label>
          <select id="moderator" formControlName="moderator" class="form-control">
            <option value="" disabled selected>Select a moderator</option>
            <option *ngFor="let moderator of moderators" [value]="moderator.ModEmail">
              {{ moderator.ModEmail }} ({{ moderator.Name }} {{ moderator.Surname }})
            </option>
          </select>
    </div>

    <div class="form-group">
      <label for="totalMarks">Assessment Name</label>
      <input type="text" id="assessmentName" formControlName="assessmentName" class="form-control">
    </div>

    <div class="form-group">
      <label for="totalMarks">Total Marks</label>
      <input type="number" id="totalMarks" formControlName="totalMarks" class="form-control" min="0" (input)="onInputChange($event)">
      <div *ngIf="assessmentForm.get('totalMarks')?.invalid && (assessmentForm.get('totalMarks')?.dirty || assessmentForm.get('totalMarks')?.touched)"></div>
        <div *ngIf="assessmentForm.get('totalMarks')?.errors?.['required']">Total Marks is required.</div>
        <div *ngIf="assessmentForm.get('totalMarks')?.errors?.['pattern']">Total Marks must be a positive number.</div>
    </div>

    <div class="form-group">
      <label for="markers">Markers</label>
      <div *ngFor="let marker of markers">
        <div class="form-check">
          <input
            class="form-check-input"
            type="checkbox"
            [id]="'marker-' + marker.MarkerEmail"
            [value]="marker.MarkerEmail"
            (change)="onMarkerChange($event, marker)"
            [checked]="isMarkerSelected(marker)"
          />
          <label class="form-check-label" [for]="'marker-' + marker.MarkerEmail">
            {{ marker.MarkerEmail }} ({{ marker.Name }} {{ marker.Surname }})
          </label>
        </div>
      </div>
    </div>
    

    <div class="form-group">
      <div class="file-upload-container">
        <br>
        <label for="memoInput">Upload the assessment memorandum:</label>
        <div class="dropzone" (drop)="onMemoDrop($event)" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (click)="memoInput.click()">
          <p>Drag and drop a file here, or click to select a file</p>
        </div>
        <div *ngIf="selectedMemoFile">
          <p>Selected file: {{ selectedMemoFile.name }}</p>
        </div>
        <input type="file" accept=".pdf" id="memoInput" style="display: none" (change)="onMemoFileSelected($event)" #memoInput>
      </div>
    </div>

    <div class="form-group">
      <div class="file-upload-container">
        <br>
        <label for="submissionsInput">Upload the submissions (in ZIP file format from Moodle):</label>
        <div class="dropzone" (drop)="onSubmissionsDrop($event)" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (click)="submissionsInput.click()">
          <p>Drag and drop a file here, or click to select a file</p>
        </div>
        <div *ngIf="selectedSubmissionsFile">
          <p>Selected file: {{ selectedSubmissionsFile.name }}</p>
        </div>
        <input type="file" accept=".zip" id="submissionsInput" style="display: none" (change)="onSubmissionsFileSelected($event)" #submissionsInput>
      </div>
    </div>
    
    <button type="submit" class="btn btn-primary" [disabled]="!assessmentForm.valid">Add Assessment</button>
  </form>
</div>